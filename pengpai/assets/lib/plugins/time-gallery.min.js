"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,a=Array(t.length);e<t.length;e++)a[e]=t[e];return a}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,a,i){return a&&t(e.prototype,a),i&&t(e,i),e}}(),TimeGallery=function(){function t(e){_classCallCheck(this,t),""===e.id&&console.error("ID not exist"),this.width=e.width||window.innerWidth,this.height=e.height||window.innerHeight,this._stage=new createjs.Stage(document.getElementById(e.id)),this._stage.canvas.width=this.width,this._stage.canvas.height=this.height,this._loadQueue=null,this._isLoading=!1,this._isEnd=!1,this.isState=e.isState||!1,this.isLog=e.isLog||!1,this.resourcesPath=e.resourcesPath||"",this.resources=e.resources||[],this.sprites=e.sprites||{},this.data=e.data||[],this.onInit=e.onInit||null,this.onEnd=e.onEnd||null,this.mapStartY=e.mapStartY||0,this.mapActiveY=e.mapActiveY||0,this.mapEndY=e.mapEndY||0,this.mapPlayY=e.mapPlayY||this.height,this.touchSpeed=e.touchSpeed||1,this.objects={},this.animatorsGroup=[],this.isMoving=!1,this.touchData={startY:0,moveY:0,friction:.9,speed:this.touchSpeed,isInertance:!1},this.title=new createjs.Bitmap,this.init()}return _createClass(t,[{key:"init",value:function(){var t=this;this._preload(this.resources,{path:this.resourcesPath,complete:function(){"function"==typeof t.sprites&&(t.sprites=t.sprites(t)),"function"==typeof t.data&&(t.data=t.data(t));var e=[{id:"map",children:t.data}];if(t._render(e,null,function(e,a){e&&a.animation&&(e.animation=t._createAnimate(e,a.animation),t.animatorsGroup.push({displayObject:e}))}),t.map=t.objects.map,t.map.y=t.mapActiveY?-t.mapActiveY:-t.mapStartY,!t.mapEndY){var a=t.map.getBounds().height+t.map.getBounds().y-t.height,i=Math.max.apply(Math,t.animatorsGroup.map(function(t){return t.displayObject.animation.mapPlayEndY}));t.mapEndY=Math.max(a,i)}t._initTouchEvent(),t.onInit&&t.onInit(),t.isState&&t._stats(),t._stage.update()}}),createjs.Ticker.timingMode=createjs.Ticker.RAF}},{key:"play",value:function(){createjs.Ticker.addEventListener("tick",this._onTick.bind(this))}},{key:"replay",value:function(){this._isEnd=!1,this.touchData={startY:0,moveY:0,friction:.92,speed:this.touchSpeed,isInertance:!1},this.map.y=-this.mapStartY,this.animatorsGroup.forEach(function(t){t.displayObject.animation.set(0)}),this._stage.update(),this.play()}},{key:"stop",value:function(){createjs.Ticker.removeAllEventListeners()}},{key:"getImage",value:function(t){return this._loadQueue.getResult(t)}},{key:"_onTick",value:function(){if(!this._isLoading&&this.isMoving){if(this.touchData.isInertance&&(this.touchData.moveY*=this.touchData.friction,Math.abs(this.touchData.moveY)<=1&&(this.touchData.startY=0,this.touchData.moveY=0,this.touchData.isInertance=!1,this.isMoving=!1)),this.map.y+=this.touchData.moveY*this.touchData.speed,this.map.y>-this.mapStartY&&(this.map.y=-this.mapStartY),this.map.y<-this.mapEndY){if(this._isEnd)return;return this._isEnd=!0,this.map.y=-this.mapEndY,void(this.onEnd&&this.onEnd())}this._updateAnimators()}this.isState&&this.stats.update()}},{key:"_updateAnimators",value:function(){var t=-this.map.y;this.animatorsGroup.map(function(e){var a=e.displayObject,i=a.animation.mapPlayStartY,n=a.animation.mapPlayEndY;if(t>=i&&t<n){var s=Math.abs(t-i);a.animation.update(s)}else t<i?a.animation.update(0):t>n&&a.animation.update(n-i)}),this._stage.update()}},{key:"_initTouchEvent",value:function(){var t=this;this._stage.canvas.addEventListener("touchstart",function(e){t.touchData.startY=e.touches[0].clientY,t.touchData.isInertance=!1,t.isMoving=!1}),this._stage.canvas.addEventListener("touchmove",function(e){t.touchData.moveY=e.touches[0].clientY-t.touchData.startY,t.touchData.startY=e.touches[0].clientY,t.isMoving=!0}),this._stage.canvas.addEventListener("touchend",function(){t.touchData.isInertance=!0})}},{key:"_preload",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=a.complete,n=void 0===i?function(){}:i,s=a.progress,o=void 0===s?function(){}:s,r=a.error,h=void 0===r?function(){}:r,c=a.path,u=void 0===c?"":c;this.isLoading=!0,this._loadQueue=new createjs.LoadQueue((!0),u),o&&this._loadQueue.on("progress",function(t){return o(t)}),h&&this._loadQueue.on("error",function(t){return h(t)}),this._loadQueue.on("complete",function(e){t.isLoading=!1,n&&n(e)}),this._loadQueue.loadManifest(e)}},{key:"_addObj",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=null;switch(t.type){case"shape":e=new createjs.Shape;break;case"bitmap":t.image&&(e=new createjs.Bitmap(t.image));break;case"text":e=new createjs.Text;break;case"sprite":if(t.sheet){var a=new createjs.SpriteSheet(t.sheet);e=new createjs.Sprite(a)}break;default:e=new createjs.Container}if(t.type?e.type=t.type:e.type="container",t.id&&(e.name=t.id),t.parent_id&&(e.parentId=t.parent_id),t.prop){var i=!0,n=!1,s=void 0;try{for(var o,r=Object.keys(t.prop)[Symbol.iterator]();!(i=(o=r.next()).done);i=!0){var h=o.value;if(e[h]instanceof Object){var c=!0,u=!1,d=void 0;try{for(var l,p=Object.keys(t.prop[h])[Symbol.iterator]();!(c=(l=p.next()).done);c=!0){var v=l.value;if("function"==typeof e[h][v]){var m;(m=e[h])[v].apply(m,_toConsumableArray(t.prop[h][v]))}else e[h][v]=t.prop[h][v]}}catch(y){u=!0,d=y}finally{try{!c&&p["return"]&&p["return"]()}finally{if(u)throw d}}}else if("function"==typeof e[h]){var f;(f=e)[h].apply(f,_toConsumableArray(t.prop[h]))}else e[h]=t.prop[h]}}catch(y){n=!0,s=y}finally{try{!i&&r["return"]&&r["return"]()}finally{if(n)throw s}}if("text"===t.type&&t.prop.align)switch(t.prop.align){case"center":e.x=(this.width-e.getBounds().width)/2;break;case"right":e.x=this.width-e.getBounds().width;break;default:e.x=0}}if(t.method){var g=!0,b=!1,Y=void 0;try{for(var _,j=Object.keys(t.method)[Symbol.iterator]();!(g=(_=j.next()).done);g=!0){var k,w=_.value;(k=e)[w].apply(k,_toConsumableArray(t.method[w]))}}catch(y){b=!0,Y=y}finally{try{!g&&j["return"]&&j["return"]()}finally{if(b)throw Y}}}if(t.event&&t.event.handle){var E=t.event.type||"click";e.addEventListener(E,t.event.handle)}if(e.getBounds()){var S=e.getBounds();e.width=S.width,e.height=S.height}return e}},{key:"_render",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=this,a=arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};t instanceof Object&&(t=Array.from(t)),t.map(function(t){t.parent_id=a,e.objects[t.id]=e._addObj(t),e.isLog&&(console.group(t.id+":"),console.table({x:e.objects[t.id].x,y:e.objects[t.id].y,regX:e.objects[t.id].regX,regY:e.objects[t.id].regY,scaleX:e.objects[t.id].scaleX,scaleY:e.objects[t.id].scaleY,rotation:e.objects[t.id].rotation,alpha:e.objects[t.id].alpha,visible:e.objects[t.id].visible})),a?e.objects[a].addChild(e.objects[t.id]):e._stage.addChild(e.objects[t.id]),i&&i(e.objects[t.id],t),t.children&&e._render(t.children,t.id,i),e.isLog&&console.groupEnd()}),this._stage.update()}},{key:"_createAnimate",value:function(t){function e(){function e(t){var i=t.parent;i&&null!==i.parent&&(a+=i.y,e(i))}var a=0;return e(t),a}function a(e){var a=e/k;if(E.length>1){var i=E.length,n=k/i,s=Math.min(e/n|0,i-1);t.image=E[s]}(T||0===T)&&(t.x=a*(T-M)+M),(X||0===X)&&(t.y=a*(X-O)+O),(b||0===b)&&(t.alpha=a*(b-Q)+Q),(c||0===c)&&(t.scaleX=a*(c-G)+G),(d||0===d)&&(t.scaleY=a*(d-R)+R),(p||0===p)&&(t.skewX=a*(p-F)+F),(m||0===m)&&(t.skewY=a*(m-H)+H),(f||0===f)&&(t.rotation=a*(f-W)+W)}var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=i.x,s=void 0===n?null:n,o=i.y,r=void 0===o?null:o,h=i.scaleX,c=void 0===h?null:h,u=i.scaleY,d=void 0===u?null:u,l=i.skewX,p=void 0===l?null:l,v=i.skewY,m=void 0===v?null:v,y=i.rotation,f=void 0===y?null:y,g=i.alpha,b=void 0===g?1:g,Y=i.top,_=void 0===Y?0:Y,j=i.duration,k=void 0===j?0:j,w=i.sprite,E=void 0===w?[]:w,S=i.startById,A=void 0===S?null:S,I=i.endById,D=void 0===I?null:I,P=i.afterById,x=void 0===P?null:P,C=i.musicById,L=void 0===C?null:C,B=t.y+e(),M=t.x,O=t.y,T=s,X=r,Q=t.alpha,G=t.scaleX,R=t.scaleY,F=t.skewX,H=t.skewY,W=t.rotation,q=!1,z=!1,J=0,K=0;return J=A?this.objects[A].animation.mapPlayStartY:x?this.objects[x].animation.mapPlayEndY:B-_>=this.mapPlayY?B-_-this.mapPlayY:this.mapStartY,D&&J<this.objects[D].animation.mapPlayEndY?(K=this.objects[D].animation.mapPlayEndY,k=K-J):K=J+k,{mapPlayStartY:J,mapPlayEndY:K,update:function(t){var e=t/k;if(0!==e&&1!==e||z!==!1){if(e>=1?(e=1,z=!1):e<=0?(e=0,z=!1):z=!0,L){var i=document.getElementById(L);i&&(q===!1?(q=!0,i.currentTime=0,i.play()):q===!0&&0===e&&(i.pause(),q=!1),i.loop&&q===!0&&1===e&&(i.pause(),q=!1))}a(t)}},set:function(t){z&&(z=!1),q&&(q=!1),a(t)}}}},{key:"_stats",value:function(){this.stats=new Stats,this.stats.showPanel(0),document.body.appendChild(this.stats.dom)}}]),t}();